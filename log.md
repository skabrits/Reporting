# Проблемы при реализации практики
## K3S HA Vagrant stage

Репозитории проекта: [начальный](https://github.com/skabrits/Teraform-local) (`REGEX: (.*)-Local-stage-Vagrant-K3s-HA/(.*)`) и [отпочковавшийся](https://github.com/skabrits/K3S-HA-Vagrant).

Репозитории сторонних ресурсов:
- [Django App](https://github.com/skabrits/ML_web)
- [DockerHub](https://hub.docker.com/repository/docker/skabrits/django)

Обозначения:
- Значком :warning: помечены те пункты, которые содержат заметные проблемы.
- Значком :radioactive: помечены те пункты, которые содержат наиболее серьёзные проблемы.

|        дата         | событие                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|:-------------------:|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  26 <br/>сентября   | <details> <summary> :radioactive: Пытался установить Vagrant, WSL, Terraform на Windows, Vagrant не удалось </summary> <ul> <li> Пытался установить vagrant на windows под WSL. </li> <li> В процессе оказалось что необходимо также установить Virtual Box. </li> <li> Оный был как поздее выяснится весьма 'так-себе' совместим с Hyper-V (kernel panic если меньше 2-х ядер и 4 Gb RAM на машинку), без которого не работает уже WSL. Этакий Ураборос. </li> <li> Но до этого я тогда не дошёл, так как wsl был отдельной средой, а vagrant я кажется ставил на windows, поэтому запуская его из под WSL ловил какие-то ошибки про: <br/> :warning: `cmd.exe not found in PATH` </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|  27 <br/>сентября   | <details> <summary> :warning: Перешёл на MAC </summary> <ul> <li> Установил Vagrant на mac </li> <li> :warning: Какие-то смутные проблемы с Vagrant destroy: вроде как не все ноды умирают. Более не встречались, как разрешились не ясно, но вероятно решение было простым. </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 27-30 <br/>сентября | <details> <summary> Работа с кубами на однонодовом кластере </summary> <ul> <li> Учусь работать с [кубами](https://github.com/eficode-academy/kubernetes-katas) </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|  30 <br/>сентября   | <details> <summary> :warning: (не)Понимаю принцип работы сервиса </summary> <ul> <li> :warning: Удивляюсь почему NodePort service плохо работает при смерти 'ноды подруги матери', хотя ничего удивительного тут нет :upside_down_face: ( или есть?) ) <details> <summary> если интересуют конкретные детали </summary> `Как будет время ответить, есть вопрос по  HA services: я на кластере с 2 worker  и 1 master сделал 8 реплик nginx с сервисом доступным через NodePorts (так как как я понял вариант с LoadBalancer работает только в облаке, а на локалке там вечное pending при получении external IP). Около половины под живут на одной ноде, оставшиеся -- на другой. Когда я убиваю одну поду -- всё работает стабильно. Но когда я убиваю одну ноду с половиной под, секунд 30 вся эта конструкция работает очень нестабильно с перерывами, пока снова не выходит на рабочий режим. Не знаете ли вы в чём дело и спасёт ли от таких проблем ещё 1 worker?`<br/>`Подключаюсь я на соответствующий порт мастер-ноды`<br/>`Я по curl каждые 500 мс запрашиваю веб страницу с мастера (192.168.56.10:30983) и если все годы работают, то стабильно каждые полсекунды оно мне выводит в консоль веб страницу. Когда я убиваю ноду №1 (на которой по всей видимости хостится активный под, у которого я и запрашивал веб страницу), сначала где-то 2-3 секунды curl не выдаёт ничего, потом снова начинает выдавать веб страницы, но не каждые пол секунды, а раз в произвольное количество времени: может например выдавать 3 раза по пол секунды, а потом с перерывом 5 секунд или 10 раз по про секунды, а потом вдруг перестать выдавать на 10 секунд. И такая фигня длится от 30 до 60 секунд, после чего он снова начинает стабильно выдавать страницу раз в пол секунды` </details> </li> </ul> </details> |
|  1-2 <br/>октября   | Выходные                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 30->3 <br/>октября  | <details> <summary> :radioactive: Борюсь за подъём HA K3S </summary> <ul> <li> :radioactive: Безуспешно пытаюсь поднять HA K3S кластер по документации Rancher на host-only adapter подсети 192.168.56.* </li> <li> :warning: Это мой первый кластер, не скопированный с инета поэтому не уверен во всём. Попутно безуспешно пытаюсь найти на K3S готовый пример HA чтобы взять его за основу. Безуспешно, так как найденные варианты имеют кучу bash кода назначение которого мне не понятно (тогда у меня было плохо с bash, т.е.) </li> <li> Это первый раз когда тупое гугление в лоб не дало результатов и пришлось несколько раз погуглить разные части логов </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|   4 <br/>октября    | <details> <summary> :warning: Победил HA K3S </summary> <ul> <li> [Проблема](https://github.com/k3s-io/k3s/issues/1267) была в необходимости (подозреваю из-за host-only адаптера) указать `--node-external-ip` </li> <li> Начались проблемы с маком: спантанно исчезающие 40 Гб на диске из-за icloud </li> <li> :warning: Предпринял безуспешную попытку миграции на windows (вот тут как раз я дошёл до 2 Босса: kernel panic) ![Паника](panic.jpg) </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   5 <br/>октября    | <details> <summary> :warning: Кризис традиционных on-prem external ALB </summary> <ul> <li> :warning: Как теперь понимаю, после работы с AWS ALB додумался до создания на NGINX ALB для сервиса типа NodePort, но не смог имплементировать из-за ограничений NGINX по перенаправлению трафика на рандомные порты нод, на которых может появится сервис типа NodePort </li> <li> Сделал NGINX external LB для HA Master Nodes для Api Server (6443 порт) </li> <li> Посему по совету проверенных камрадов и мудрых наставников начал имплементацию MetalLB </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|  8-9 <br/>октября   | Выходные                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|  5-12 <br/>октября  | <details> <summary> Чистил нычки перед переходом на следующий уровень </summary> <ul> <li> Допилил MetalLB </li> <li> Привёл всё в рабочий вид, с тестовым приложением в виде NGINX </li> <li> Вспомнил DJANGO (после 3 лет забвения) </li> <li> Разобрался с Докер, Докерхаб </li> <li> Написал свои Deployment и Service </li> <li> Начал изучать HCL </li> <li> Настроил Amazon аккаунт </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

## AWS EKS Terraform stage

Репозитории проекта: [начальный](https://github.com/skabrits/Teraform-local) (`REGEX: (.*)-Inter-stage-Terraform/(.*)`) и [отпочковавшийся](https://github.com/skabrits/Terraform-EKS).

Репозитории сторонних ресурсов:
- [Django App](https://github.com/skabrits/ML_web)
- [Helm S3 repo](https://www.google.com/search?q=s3%3A%2F%2Fskabrits-bucket%2Fhelm%2Fcharts&oq=s3%3A%2F%2Fskabrits-bucket%2Fhelm%2Fcharts&aqs=chrome.0.69i59j69i58.3270j0j4&sourceid=chrome&ie=UTF-8)
- [План защиты, Part I, II](plan.md)

Обозначения:
- Значком :warning: помечены те пункты, которые содержат заметные проблемы.
- Значком :radioactive: помечены те пункты, которые содержат наиболее серьёзные проблемы.

|        дата         | событие                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|:-------------------:|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|   13 <br/>октября   | <details> <summary> Рассуждения о безопасности </summary> <ul> <li> Задался вопросом о создании системы атоматического хранения ключей <details> <summary> если интересуют конкретные детали </summary> `Вопрос: правильно ли я понимаю, что если при работе с terraform sensitive данные (напр, ключи/пароли от aws и dockerhub) хранятся в виде plane text это не является проблемой, а проблемой это становится, когда они утекают в репозиторий? То есть, что условно говоря можно выложить в репозиторий зашифрованную связку ключей (vault или что-то ещё) и скрипт, требующий 1 пароля и расшифровывающий связку на компе у разраба и засовывающий данные в файлы типо terraform.tfvars в виде plane text?`<br/>`Или же нужна такая система при которой сам разработчик знает толко один пароль, а всё остальное не должно быть ему известно`<br/>`То есть по сути этот вопрос распадается на 2:`<br/>`Можно ли считать что мы доверяем разработчику и можно ли считать что пока он работает его компьютер неуязвим с точки зрания кражи файлов или переменных окружения`<br/>`Просто учитывая количество требуемых паролей (пароль от докерхаба, IAM user aws, потенциально другие пароли) чтобы их не вводить миллион раз вручную было бы логично поместить их или в отдельное сетевое хранилище, откуда они скриптом по токену подставлялись бы в terraform или в качестве такого сетевого хранилища использовать сам репозиторий гитхаба, зашифровав пароли так чтобы скрипт их расшифровывал бы по токену и опять таки подставлял в терраформ`<br/>`Кстати, в самом терраформе есть как минимум 2 варианта подстановки переменных: через *.tfvars и через переменные окружения. Какой из них лучше с точки зрения безопасности (считая что после развёртывания терраформа переменные среды можно почистить, а файл *.tfvars -- удалить)` </details></li> <li> Начал изучать bash для создания локального Vault спомощью OpenSSL </li> <li> Благодаря этому разобрался в bash скриптах (циклы, переменные, флаги, условные операторы и тп) </li> <li> Создал helm и начал миграцию в S3 </li> </ul> </details> |
| 15-16 <br/>октября  | Выходные                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ~14-17 <br/>октября | <details> <summary> Углублялся </summary> <ul> <li> Изучал HCL </li> <li> Изучал Bash </li> </ul> <li> Пытался развернуть Terraform vagrant on-prem, но быстро отказался от идеи за отсутствием смысла </li> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|   17 <br/>октября   | <details> <summary> Programm to defend </summary> <ul> <li> Появилась [программа](plan.md) для защиты </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   18 <br/>октября   | <details> <summary> :warning: AWS EKS Terraform развёртывание </summary> <ul> <li> Пытался найти подробно объяснённое развёртывание кластера EKS, но ничего лучше [HASHICORP туториала](https://developer.hashicorp.com/terraform/tutorials/kubernetes/eks) не нашёл </li> <li> :warning: Выкинул из туториала всё что считал на тот момент 'ненужным переусложнением'. Запомните этот момент, он ещё сыграет свою роль в будущем. </li> <li> :warning: отлавливал баг в bash скрипте <details> <summary> если интересуют конкретные детали </summary> 4 часа отлавливал баг: терраформ нормально работал если запускать с консоли, но из скрипта ломался. Оказалось, в yaml файле в котором хранились переменные паролей значения были в кавычках и эти кавычки и были тем что не давало тераформу корректно работать 🤣🤣🤣 </details> </li> <li> Рассуждения о развёртывании кластера для интеграционных и end-to-end тестов в условиях нехватки ресурсов и длительной молоинтенсивной разработки <details> <summary> если интересуют конкретные детали </summary> Кстати, насколько имеет смысл в целях экономии по коммиту не просто подпушивать в кластер обновившийся helm релиз, но и предварительно запускать кластер? То есть, понятно что если у нас есть большой кластер на котором много всего работает за который платит клиент и у него есть другие приложения и сервисы то кластер каждый раз сворачивать и разворачивать смысла нет, но если скажем у нас кластер создаётся под конкретный набор микросервисов, которые находятся в разработке на ранней стадии, насколько целесообразно и выгодно ли каждый раз разворачивать для тестов и потом сворачивать кластер </details> </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                  |
|   19 <br/>октября   | <details> <summary> Дорабатывал приложение </summary> <ul> <li> Добавил в приложение функцию вывода текущего коммита </li> <li> Посмотрел на MetalLB FRR BGP, потом на host-only adapter, потом снова на FRR BGP, испугался и больше туда особо не смотрел </li> <li> До того как испугался нашёл на гитхабе (ссылка увы не сохранилась) репозиторий, в котором это было реализовано в несколько упрощённом виде, но недостаточно понимал предмет и решил не браться за переделывание, из страха что это займёт слишком много времени </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 20-22 <br/>октября  | <details> <summary> S3 time </summary> <ul> <li> Развернул на Terraform state storage bucket, dynamodb lock table, helm s3 storage, ecr storage </li> <li> Задеплоил в EKS helm chart со своим приложением через service LoadBalancer </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 22-23 <br/>октября  | Выходные                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 22-25 <br/>октября  | <details> <summary> CI/CD </summary> <ul> <li> Настроил через github Actions image build, ecr push, helm package, helm push и helm install (upgrade) в EKS кластер </li> <li> КЕК (Начал рубрику мемов для друзей из универа) ![*rasPutin](put.jpg) </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 26-27 <br/>октября  | <details> <summary> :warning: Подготовка к защите </summary> <ul> <li> :warning: Непонял как делать презу </li> <li> Понял как делать презу </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   28 <br/>октября   | <details> <summary> Защита </summary> <ul> <li> С 9:00 до 12:00 доделал презу и убедился в надёжности кластеров </li> <li> За 20 минут до защиты прочитал twelve factor </li> <li> Защитился </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

<details> <summary>  </summary> <ul> <li>  </li> </ul> </details>

## EFK + Monitoring stage

### Начало

### On-prem

### AWS

## ArgoCD Stage

## Kube-flow