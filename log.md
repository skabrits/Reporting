# Проблемы при реализации практики
## K3S HA Vagrant stage

Репозитории проекта: [начальный](https://github.com/skabrits/Teraform-local) (`REGEX: (.*)-Local-stage-Vagrant-K3s-HA/(.*)`) и [отпочковавшийся](https://github.com/skabrits/K3S-HA-Vagrant).

- Значком :warning: помечены те пункты, которые содержат заметные проблемы.
- Значком :radioactive: помечены те пункты, которые содержат наиболее серьёзные проблемы.

|        дата         | событие                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|:-------------------:|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  26 <br/>сентября   | <details> <summary> :radioactive: Пытался установить Vagrant, WSL, Terraform на Windows, Vagrant не удалось </summary> <ul> <li> Пытался установить vagrant на windows под WSL. </li> <li> В процессе оказалось что необходимо также установить Virtual Box. </li> <li> Оный был как поздее выяснится весьма 'так-себе' совместим с Hyper-V (kernel panic если меньше 2-х ядер и 4 Gb RAM на машинку), без которого не работает уже WSL. Этакий Ураборос. </li> <li> Но до этого я тогда не дошёл, так как wsl был отдельной средой, а vagrant я кажется ставил на windows, поэтому запуская его из под WSL ловил какие-то ошибки про: <br/> :warning: `cmd.exe not found in PATH` </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  27 <br/>сентября   | <details> <summary> :warning: Перешёл на MAC </summary> <ul> <li> Установил Vagrant на mac </li> <li> Какие-то смутные проблемы с Vagrant destroy: вроде как не все ноды умирают. Более не встречались, как разрешились не ясно, но вероятно решение было простым. </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 27-30 <br/>сентября | <details> <summary> Работа с кубами на однонодовом кластере </summary> <ul> <li> Учусь работать с [кубами](https://github.com/eficode-academy/kubernetes-katas) </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|  30 <br/>сентября   | <details> <summary> :warning: (не)Понимаю принцип работы сервиса </summary> <ul> <li> Удивляюсь почему NodePort service плохо работает при смерти 'ноды подруги матери', хотя ничего удивительного тут нет :upside_down_face: ( или есть?) ) <details> <summary> если интересуют конкретные детали </summary> `Как будет время ответить, есть вопрос по  HA services: я на кластере с 2 worker  и 1 master сделал 8 реплик nginx с сервисом доступным через NodePorts (так как как я понял вариант с LoadBalancer работает только в облаке, а на локалке там вечное pending при получении external IP). Около половины под живут на одной ноде, оставшиеся -- на другой. Когда я убиваю одну поду -- всё работает стабильно. Но когда я убиваю одну ноду с половиной под, секунд 30 вся эта конструкция работает очень нестабильно с перерывами, пока снова не выходит на рабочий режим. Не знаете ли вы в чём дело и спасёт ли от таких проблем ещё 1 worker?`<br/>`Подключаюсь я на соответствующий порт мастер-ноды`<br/>`Я по curl каждые 500 мс запрашиваю веб страницу с мастера (192.168.56.10:30983) и если все годы работают, то стабильно каждые полсекунды оно мне выводит в консоль веб страницу. Когда я убиваю ноду №1 (на которой по всей видимости хостится активный под, у которого я и запрашивал веб страницу), сначала где-то 2-3 секунды curl не выдаёт ничего, потом снова начинает выдавать веб страницы, но не каждые пол секунды, а раз в произвольное количество времени: может например выдавать 3 раза по пол секунды, а потом с перерывом 5 секунд или 10 раз по про секунды, а потом вдруг перестать выдавать на 10 секунд. И такая фигня длится от 30 до 60 секунд, после чего он снова начинает стабильно выдавать страницу раз в пол секунды` </details> </li> </ul> </details> |
| 30->3 <br/>октября  | <details> <summary> :radioactive: Борюсь за подъём HA K3S </summary> <ul> <li> Безуспешно пытаюсь поднять HA K3S кластер по документации Rancher на host-only adapter подсети 192.168.56.* </li> <li> Это мой первый кластер, не скопированный с инета поэтому не уверен во всём. Попутно безуспешно пытаюсь найти на K3S готовый пример HA чтобы взять его за основу. Безуспешно, так как найденные варианты имеют кучу bash кода назначение которого мне не понятно (тогда у меня было плохо с bash, т.е.) </li> <li> Это первый раз когда тупое гугление в лоб не дало результатов и пришлось несколько раз погуглить разные части логов </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|   4 <br/>октября    | <details> <summary> :warning: Победил HA K3S </summary> <ul> <li> [Проблема](https://github.com/k3s-io/k3s/issues/1267) была в необходимости (подозреваю из-за host-only адаптера) указать `--node-external-ip` </li> <li> Начались проблемы с маком: спантанно исчезающие 40 Гб на диске из-за icloud </li> <li> Предпринял безуспешную попытку миграции на windows (вот тут как раз я дошёл до 2 Босса: kernel panic) ![Паника](panic.jpg) </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   5 <br/>октября    | <details> <summary> :warning: Кризис традиционных on-prem external ALB </summary> <ul> <li> Как теперь понимаю, после работы с AWS ALB додумался до создания на NGINX ALB для сервиса типа NodePort, но не смог имплементировать из-за ограничений NGINX по перенаправлению трафика на рандомные порты нод, на которых может появится сервис типа NodePort </li> <li> Сделал NGINX external LB для HA Master Nodes для Api Server (6443 порт) </li> <li> Посему по совету проверенных камрадов и мудрых наставников начал имплементацию MetalLB </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|  5-12 <br/>октября  | <details> <summary> Чистил нычки перед переходом на следующий уровень </summary> <ul> <li> Допилил MetalLB </li> <li> Привёл всё в рабочий вид, с тестовым приложением в виде NGINX </li> <li> Вспомнил DJANGO (после 3 лет забвения) </li> <li> Разобрался с Докер, Докерхаб </li> <li> Написал свои Deployment и Service </li> </ul> </details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

<details> <summary>  </summary> <ul> <li>  </li> </ul> </details>

## AWS EKS Terraform stage

## EFK + Monitoring stage

### Начало

### On-prem

### AWS

## ArgoCD Stage

## Kube-flow